name: Build and Release MicaPDF

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build x64 Release
      run: dotnet publish -c Release -r win-x64 -p:Platform=x64 --self-contained false -p:PublishSingleFile=true -p:PublishReadyToRun=true
      
    - name: Build ARM64 Release
      run: dotnet publish -c Release -r win-arm64 -p:Platform=ARM64 --self-contained false -p:PublishSingleFile=true -p:PublishReadyToRun=true
      
    - name: Create Release Folder
      run: |
        New-Item -ItemType Directory -Force -Path "Release"
      shell: pwsh
      
    - name: Create Installation Instructions
      run: |
        @"
        MicaPDF - Modern PDF Viewer for Windows
        ========================================

        Installation Instructions:
        
        1. Download the appropriate version for your system:
           - MicaPDF-x64.exe (for 64-bit Windows - most common)
           - MicaPDF-ARM64.exe (for ARM64 Windows devices)
        
        2. Run the downloaded file
        
        3. The app will ask if you want to set it as default PDF reader
           - Click "Yes, Open Settings" to set as default
           - Follow the on-screen instructions
        
        4. Features:
           - Modern Mica translucent background
           - High-quality PDF rendering
           - Advanced zoom (up to 500%)
           - Page navigation with keyboard shortcuts
           - Pen annotation support
           - Touch and mouse pan/drag
           - Save annotated pages as images
           - Drag & drop PDF files
        
        5. Usage:
           - Open PDFs by dragging them onto the app window
           - Use the side menu for all controls
           - Enable pen mode to draw annotations
           - Save annotated pages with "Save with Annotations"
        
        Requirements:
        - Windows 10 version 1809 (build 17763) or later
        - Windows 11 recommended for best Mica effect
        - .NET Desktop Runtime 8.0 (installer will prompt to download if missing)
        
        "@ | Out-File -FilePath "Release\INSTALL.txt" -Encoding UTF8
      shell: pwsh
      
    - name: Create README
      run: |
        @"
        # MicaPDF

        A modern, beautiful PDF viewer for Windows with translucent Mica background effect.

        ## Features

        - üé® **Modern UI**: Beautiful Mica translucent background that blends with your desktop
        - üìÑ **High Quality**: High-definition PDF rendering (2x resolution)
        - üîç **Advanced Zoom**: Zoom from 50% to 500%
        - ‚úèÔ∏è **Annotations**: Draw and write on PDFs with pen support
        - üíæ **Save Annotated**: Save your annotated pages as PNG images
        - üñ±Ô∏è **Touch & Mouse**: Full touch and mouse support with pan/drag
        - ‚å®Ô∏è **Keyboard Shortcuts**: Navigate pages with Enter key
        - üìÇ **Drag & Drop**: Drop PDF files directly on the app
        - üéØ **File Association**: Set as default PDF reader

        ## System Requirements

        - Windows 10 (build 17763) or later
        - Windows 11 recommended for best visual experience

        ## Download

        Download the latest release from the [Releases](../../releases) page.

        ## Installation

        1. Download the appropriate version for your system
        2. Run the executable
        3. The app will prompt you to set it as default PDF reader
        4. Enjoy!

        ## Building from Source

        ``````bash
        git clone https://github.com/yourusername/MicaPDF.git
        cd MicaPDF
        dotnet build -p:Platform=x64
        ``````

        ## License

        MIT License - See LICENSE file for details

        "@ | Out-File -FilePath "Release\README.md" -Encoding UTF8
      shell: pwsh
      
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
      shell: pwsh
      
    - name: Create x64 Installer Script
      run: |
        @"
        #define MyAppName "MicaPDF"
        #define MyAppVersion "1.0.0"
        #define MyAppPublisher "MicaPDF"
        #define MyAppURL "https://github.com/yourusername/MicaPDF"
        #define MyAppExeName "MicaPDF.exe"

        [Setup]
        AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}
        AppUpdatesURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        DefaultGroupName={#MyAppName}
        AllowNoIcons=yes
        OutputDir=Release
        OutputBaseFilename=MicaPDF-Setup-x64
        Compression=lzma2
        SolidCompression=yes
        WizardStyle=modern
        ArchitecturesAllowed=x64
        ArchitecturesInstallIn64BitMode=x64
        PrivilegesRequired=lowest

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "bin\x64\Release\net8.0-windows10.0.22621.0\win-x64\publish\MicaPDF.exe"; DestDir: "{app}"; Flags: ignoreversion

        [Icons]
        Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
        Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

        [Run]
        Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent

        [Registry]
        Root: HKCU; Subkey: "Software\Classes\.pdf"; ValueType: string; ValueName: ""; ValueData: "MicaPDF.Document"; Flags: uninsdeletevalue
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document"; ValueType: string; ValueName: ""; ValueData: "PDF Document"; Flags: uninsdeletekey
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document\DefaultIcon"; ValueType: string; ValueName: ""; ValueData: "{app}\{#MyAppExeName},0"
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document\shell\open\command"; ValueType: string; ValueName: ""; ValueData: """{app}\{#MyAppExeName}"" ""%1"""

        [Code]
        function InitializeSetup: Boolean;
        var
          ErrorCode: Integer;
          NetRuntimeInstalled: Boolean;
          Result1: Boolean;
        begin
          // Check for .NET 8 Desktop Runtime (x64)
          // Registry key for .NET 8
          NetRuntimeInstalled := RegKeyExists(HKLM, 'SOFTWARE\WOW6432Node\dotnet\Setup\InstalledVersions\x64\sharedhost\Microsoft.NETCore.App\8.0.0') or 
                                 RegKeyExists(HKLM, 'SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedhost\Microsoft.NETCore.App\8.0.0');

          if not NetRuntimeInstalled then
          begin
            if MsgBox('This application requires .NET Desktop Runtime 8.0. Would you like to download it now?', mbConfirmation, MB_YESNO) = IDYES then
            begin
              ShellExec('open', 'https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/runtime-desktop-8.0.0-windows-x64-installer', '', '', SW_SHOWNORMAL, mbConfirmation, ErrorCode);
              MsgBox('Please install the .NET Runtime and then run this setup again.', mbInformation, MB_OK);
              Result := False;
            end
            else
            begin
              MsgBox('.NET Runtime 8.0 is required. Setup cannot continue.', mbCriticalError, MB_OK);
              Result := False;
            end;
          end
          else
          begin
            Result := True;
          end;
        end;
        "@ | Out-File -FilePath "installer-x64.iss" -Encoding UTF8
      shell: pwsh
      
    - name: Create ARM64 Installer Script
      run: |
        @"
        #define MyAppName "MicaPDF"
        #define MyAppVersion "1.0.0"
        #define MyAppPublisher "MicaPDF"
        #define MyAppURL "https://github.com/yourusername/MicaPDF"
        #define MyAppExeName "MicaPDF.exe"

        [Setup]
        AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}
        AppUpdatesURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        DefaultGroupName={#MyAppName}
        AllowNoIcons=yes
        OutputDir=Release
        OutputBaseFilename=MicaPDF-Setup-ARM64
        Compression=lzma2
        SolidCompression=yes
        WizardStyle=modern
        ArchitecturesAllowed=arm64
        ArchitecturesInstallIn64BitMode=arm64
        PrivilegesRequired=lowest

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "bin\ARM64\Release\net8.0-windows10.0.22621.0\win-arm64\publish\MicaPDF.exe"; DestDir: "{app}"; Flags: ignoreversion

        [Icons]
        Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
        Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

        [Run]
        Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent

        [Registry]
        Root: HKCU; Subkey: "Software\Classes\.pdf"; ValueType: string; ValueName: ""; ValueData: "MicaPDF.Document"; Flags: uninsdeletevalue
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document"; ValueType: string; ValueName: ""; ValueData: "PDF Document"; Flags: uninsdeletekey
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document\DefaultIcon"; ValueType: string; ValueName: ""; ValueData: "{app}\{#MyAppExeName},0"
        Root: HKCU; Subkey: "Software\Classes\MicaPDF.Document\shell\open\command"; ValueType: string; ValueName: ""; ValueData: """{app}\{#MyAppExeName}"" ""%1"""

        [Code]
        function InitializeSetup: Boolean;
        var
          ErrorCode: Integer;
          NetRuntimeInstalled: Boolean;
          Result1: Boolean;
        begin
          // Check for .NET 8 Desktop Runtime (ARM64)
          NetRuntimeInstalled := RegKeyExists(HKLM, 'SOFTWARE\dotnet\Setup\InstalledVersions\arm64\sharedhost\Microsoft.NETCore.App\8.0.0');

          if not NetRuntimeInstalled then
          begin
            if MsgBox('This application requires .NET Desktop Runtime 8.0. Would you like to download it now?', mbConfirmation, MB_YESNO) = IDYES then
            begin
              ShellExec('open', 'https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/runtime-desktop-8.0.0-windows-arm64-installer', '', '', SW_SHOWNORMAL, mbConfirmation, ErrorCode);
              MsgBox('Please install the .NET Runtime and then run this setup again.', mbInformation, MB_OK);
              Result := False;
            end
            else
            begin
              MsgBox('.NET Runtime 8.0 is required. Setup cannot continue.', mbCriticalError, MB_OK);
              Result := False;
            end;
          end
          else
          begin
            Result := True;
          end;
        end;
        "@ | Out-File -FilePath "installer-arm64.iss" -Encoding UTF8
      shell: pwsh
      
    - name: Build Installers
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-x64.iss
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-arm64.iss
      shell: pwsh
      continue-on-error: true
      
    - name: Create Portable ZIP
      run: |
        Compress-Archive -Path "bin\x64\Release\net8.0-windows10.0.22621.0\win-x64\publish\MicaPDF.exe", "Release\INSTALL.txt", "Release\README.md" -DestinationPath "Release\MicaPDF-Portable-x64.zip" -Force
        Compress-Archive -Path "bin\ARM64\Release\net8.0-windows10.0.22621.0\win-arm64\publish\MicaPDF.exe", "Release\INSTALL.txt", "Release\README.md" -DestinationPath "Release\MicaPDF-Portable-ARM64.zip" -Force
      shell: pwsh
      
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: MicaPDF-Release
        path: |
          Release/*.exe
          Release/*.zip
          Release/*.txt
          Release/*.md
          
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Release/MicaPDF-Portable-x64.zip
          Release/MicaPDF-Portable-ARM64.zip
          Release/MicaPDF-Setup-x64.exe
          Release/MicaPDF-Setup-ARM64.exe
          Release/INSTALL.txt
          Release/README.md
        body: |
          ## MicaPDF Release
          
          A modern PDF viewer with translucent Mica background for Windows.
          
          ### Downloads
          
          **Installer (Recommended)**
          - `MicaPDF-Setup-x64.exe` - Windows Installer for 64-bit systems
          - `MicaPDF-Setup-ARM64.exe` - Windows Installer for ARM64 devices
          
          All installers include automatic file association setup.
          
          **Portable Versions**
          - `MicaPDF-Portable-x64.zip` - Portable version for 64-bit Windows
          - `MicaPDF-Portable-ARM64.zip` - Portable version for ARM64 Windows
          
          ### Features
          - Modern Mica translucent UI
          - High-quality PDF rendering
          - Pen annotations
          - Touch and mouse support
          - Set as default PDF reader
          
          ### Requirements
          - Windows 10 (build 17763) or later
          - Windows 11 recommended
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
